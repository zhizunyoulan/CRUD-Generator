import { createRouter, createWebHistory } from '@ionic/vue-router';
import { RouteRecordRaw } from 'vue-router';
import TabsPage from '../views/TabsPage.vue'
import { getToken } from '@/utils/auth';
const whiteList = ['/login', '/auth-redirect'];

#set($paramPath = "")
#foreach ($primaryKeyField in $mainModel.primaryKeyFields)## A
#set($paramPath = $paramPath + "/:${primaryKeyField.property}")
#end## A
const routes: Array<RouteRecordRaw> = [
  {
    path: '/',
    redirect: '/tabs/home'
  },
  {
    path: '/login',
    component: () => import('@/views/LoginPage.vue')
  },
  {
    path: '/tabs/',
    component: TabsPage,
    children: [
      {
        path: '',
        redirect: '/tabs/home'
      },
      {
        path: 'home',
        component: () => import('@/views/HomePage.vue')
      },
      {
        path: 'user',
        component: () => import('@/views/UserPage.vue')
      },
      {
        path: '${mainModel.kebabCaseModelName}',
        component: () => import('@/$myTool.pathOf("src").relativize($myTool.relativePathOf("FRONTEND_VIEW"))'),
        name: '${mainModel.modelName}View',
      },
#if($createDefinition != $null || $updateDefinition != $null)## A
      {
        path: '${mainModel.kebabCaseModelName}/form/:useFor',
        component: () => import('@/$myTool.pathOf("src").relativize($myTool.relativePathOf("FRONTEND_FORM"))'),
        name: '${mainModel.modelName}Form',
        props: true
      },
#end## A
    ]
  },
  {
    path: '/404',
    component: () => import('@/views/404Page.vue'),
  },
]

const router = createRouter({
  history: createWebHistory(import.meta.env.BASE_URL),
  routes
})

router.beforeEach(async (to, from, next) => {
  // start progress bar
  if (to.matched.length == 0) {
    next({ path: "/404" });
  } else {
    // determine whether the user has logged in
    const hasToken = getToken();
    if (hasToken) {
      if (to.path === "/login") {
        // if is logged in, redirect to the home page
        next({ path: "/" });
      } else {
        next();
      }
    } else {
      /* has no token*/
      if (whiteList.indexOf(to.path) !== -1) {
        // in the free login whitelist, go directly
        next();
      } else {
        // other pages that do not have permission to access are redirected to the login page.
        next(`/login?redirect=${to.path}`);
      }
    }
  }
});

export default router;